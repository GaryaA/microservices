# Summary: Section 19 - Introduction to K8s Ingress, Service Mesh (Istio) & mTLS

## Обзор секции

В девятнадцатой секции курса изучались продвинутые сетевые концепции Kubernetes: Ingress для управления входящим трафиком, Service Mesh (Istio) для управления межсервисной коммуникацией и mTLS для обеспечения безопасности.

## Что было изучено

### 1. Kubernetes Ingress
- Управление входящим HTTP/HTTPS трафиком
- Единая точка входа для внешних запросов
- Маршрутизация на основе хоста и пути
- SSL/TLS termination

### 2. Ingress Controller
- Реализации Ingress контроллеров:
  - NGINX Ingress Controller
  - Traefik
  - Istio Gateway
- Установка и настройка
- Настройка правил маршрутизации

### 3. Ingress Rules
- Правила маршрутизации по хосту
- Правила маршрутизации по пути
- Backend services
- TLS сертификаты

### 4. Service Mesh концепция
- Управление межсервисной коммуникацией
- Observability на уровне сети
- Безопасность коммуникаций
- Управление трафиком

### 5. Istio
- Популярный Service Mesh
- Компоненты:
  - **Istiod** - control plane
  - **Envoy** - data plane (sidecar proxy)
  - **Pilot** - управление трафиком
  - **Citadel** - безопасность
  - **Galley** - конфигурация

### 6. Istio Features
- **Traffic Management** - маршрутизация, балансировка, retry
- **Security** - mTLS, авторизация
- **Observability** - метрики, логи, трассировка
- **Policy Enforcement** - rate limiting, quotas

### 7. mTLS (Mutual TLS)
- Двусторонняя аутентификация
- Шифрование трафика между сервисами
- Автоматическое управление сертификатами
- Защита от man-in-the-middle атак

### 8. Istio Configuration
- VirtualService - правила маршрутизации
- DestinationRule - политики для destinations
- Gateway - управление входящим трафиком
- PeerAuthentication - настройка mTLS

## Что было реализовано

### Ingress Configuration
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: eazybank-ingress
spec:
  rules:
  - host: api.eazybank.com
    http:
      paths:
      - path: /accounts
        pathType: Prefix
        backend:
          service:
            name: accounts
            port:
              number: 8080
```

### Istio Installation
- Установка Istio в кластер
- Настройка автоматической инъекции sidecar
- Конфигурация для микросервисов

### mTLS Configuration
```yaml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
spec:
  mtls:
    mode: STRICT
```

### VirtualService Example
```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: accounts
spec:
  hosts:
  - accounts
  http:
  - route:
    - destination:
        host: accounts
```

## Технические детали

### Ingress Controller
- NGINX как популярный выбор
- Установка через Helm или YAML
- Настройка для production

### Istio Components
- **Envoy Proxy** - sidecar в каждом поде
- **Istiod** - централизованное управление
- **Pilot** - service discovery и load balancing
- **Citadel** - управление сертификатами

### mTLS Modes
- **STRICT** - обязательный mTLS
- **PERMISSIVE** - поддержка plain text и mTLS
- **DISABLE** - отключение mTLS

## Best Practices

1. **Ingress для внешнего трафика** - единая точка входа
2. **Service Mesh для внутреннего трафика** - управление межсервисной коммуникацией
3. **mTLS везде** - шифрование всего трафика
4. **Gradual adoption** - постепенное внедрение Istio
5. **Monitoring** - использование observability возможностей
6. **Security policies** - настройка авторизации

## Результаты секции

После завершения девятнадцатой секции студенты:
1. Понимают Kubernetes Ingress
2. Знают концепцию Service Mesh
3. Умеют настраивать Istio
4. Понимают mTLS и его важность
5. Знают, как управлять трафиком через Istio
6. Знают best practices для сетевой безопасности

## Детальный процесс обработки запроса с mTLS

### Архитектура пода с Istio

```
┌─────────────────────────────────────┐
│         Pod: accounts               │
│  ┌──────────────┐  ┌──────────────┐ │
│  │   Accounts   │  │ Envoy Sidecar│ │
│  │  Application │  │    Proxy     │ │
│  │   (8080)     │  │   (15001)    │ │
│  └──────┬───────┘  └──────┬───────┘ │
│         │                  │         │
│         └────────┬─────────┘         │
│                  │                   │
│         ┌────────▼────────┐          │
│         │  iptables rules │          │
│         │  (перехват)     │          │
│         └─────────────────┘          │
└─────────────────────────────────────┘
```

### Пошаговый процесс обработки исходящего запроса (Service A → Service B)

#### 1. Приложение отправляет запрос
- Приложение отправляет обычный HTTP запрос
- Обращается к своему сервису по localhost
- **Приложение не знает о mTLS** - работает с обычным HTTP

#### 2. iptables перехватывает трафик
- Istio настраивает iptables правила при старте пода
- Все исходящие соединения автоматически перенаправляются на Envoy sidecar (порт 15001)
- Приложение не замечает перехват

#### 3. Envoy Sidecar получает запрос
- Envoy анализирует destination (куда идет запрос)
- Проверяет PeerAuthentication для destination
- Если `mode: STRICT` → инициирует mTLS соединение

#### 4. Envoy получает сертификаты
- Сертификаты хранятся в `/etc/certs/` внутри sidecar контейнера
- Автоматически выдаются и обновляются Istiod (Citadel)
- Содержат:
  - `cert-chain.pem` - сертификат сервиса
  - `key.pem` - приватный ключ
  - `root-cert.pem` - корневой CA сертификат

#### 5. Установка mTLS соединения (TLS Handshake)
Процесс TLS handshake:
1. **Client Hello** (Envoy A → Envoy B):
   - Envoy A отправляет список поддерживаемых cipher suites
   - Отправляет свой сертификат
2. **Server Hello** (Envoy B → Envoy A):
   - Envoy B выбирает cipher suite
   - Отправляет свой сертификат
3. **Взаимная проверка сертификатов**:
   - Оба проверяют сертификаты друг друга через root-cert
   - Проверяют подпись и срок действия
4. **Обмен ключами**:
   - Генерируется общий секретный ключ
   - Используется для симметричного шифрования
5. **Установка зашифрованного канала**:
   - Все дальнейшие данные шифруются

#### 6. Шифрование HTTP запроса
- **Момент шифрования**: после перехвата iptables, перед отправкой в сеть
- Envoy шифрует HTTP запрос используя установленное mTLS соединение
- Отправляет зашифрованные данные через сеть
- **Трафик между подами полностью зашифрован**

### Пошаговый процесс обработки входящего запроса (Service B получает)

#### 1. Envoy Sidecar B получает зашифрованный трафик
- iptables перехватывает входящий трафик
- Перенаправляет на Envoy sidecar (порт 15006 для входящих)

#### 2. Расшифровка mTLS
- **Момент расшифровки**: сразу после получения из сети, до передачи в приложение
- Envoy B проверяет сертификат Envoy A
- Проверяет подпись через root-cert
- Расшифровывает данные
- Получает оригинальный HTTP запрос

#### 3. Применение политик
- Envoy проверяет AuthorizationPolicy (если настроена)
- Применяет rate limiting
- Применяет routing rules (VirtualService)

#### 4. Передача в приложение
- Envoy отправляет расшифрованный HTTP запрос в приложение
- Приложение получает обычный HTTP запрос
- **Приложение не знает о mTLS** - работает с обычным HTTP

### Процесс обработки ответа (Service B → Service A)

1. Приложение отправляет HTTP ответ
2. iptables перехватывает ответ
3. Envoy B шифрует ответ используя уже установленное mTLS соединение
4. Отправляет зашифрованные данные через сеть
5. Envoy A получает и расшифровывает ответ
6. Передает HTTP ответ в приложение

### Визуализация потока данных

```
┌─────────────────────────────────────────────────────────────┐
│                    Исходящий запрос                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  [Accounts App]                                              │
│      │                                                       │
│      │ HTTP (plain text)                                     │
│      ▼                                                       │
│  [iptables] ──перехват──► [Envoy Sidecar A]                │
│      │                           │                          │
│      │                           │ 1. Получение сертификата │
│      │                           │    от Istiod              │
│      │                           │                          │
│      │                           │ 2. TLS Handshake         │
│      │                           │    (Client Hello)         │
│      │                           │                          │
│      │                           │ 3. Шифрование HTTP       │
│      │                           │                          │
│      │                           ▼                          │
│      │                    [Сеть - зашифровано]              │
│      │                                                       │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    Входящий запрос                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  [Сеть - зашифровано]                                        │
│      │                                                       │
│      │ 1. iptables перехват                                  │
│      ▼                                                       │
│  [Envoy Sidecar B]                                           │
│      │                                                       │
│      │ 2. Проверка сертификата A                             │
│      │                                                       │
│      │ 3. Расшифровка                                        │
│      │                                                       │
│      │ 4. Проверка AuthorizationPolicy                       │
│      │                                                       │
│      ▼                                                       │
│  [Cards App]                                                 │
│      │ HTTP (plain text)                                     │
│      │                                                       │
└─────────────────────────────────────────────────────────────┘
```

### Ключевые моменты

1. **Шифрование происходит на уровне сети**:
   - Между Envoy sidecar прокси
   - Не в приложении
   - Прозрачно для приложения

2. **Моменты шифрования/расшифровки**:
   - **Исходящий**: после перехвата iptables, перед отправкой в сеть
   - **Входящий**: сразу после получения из сети, до передачи в приложение

3. **Сертификаты**:
   - Выдаются автоматически Istiod (Citadel)
   - Хранятся в `/etc/certs/` в sidecar контейнере
   - Обновляются автоматически (обычно каждые 24 часа)

4. **iptables правила**:
   - Настраиваются автоматически при инъекции sidecar
   - Перехватывают весь трафик на портах приложения
   - Перенаправляют на Envoy (15001 - исходящий, 15006 - входящий)

### Команды для проверки работы mTLS

```bash
# Проверить сертификаты в поде
kubectl exec -it <pod-name> -c istio-proxy -- ls /etc/certs/
# Должны быть: cert-chain.pem, key.pem, root-cert.pem

# Проверить статус mTLS
istioctl authn tls-check accounts.default.svc.cluster.local

# Проверить iptables правила
kubectl exec -it <pod-name> -c istio-proxy -- iptables -t nat -L
```

### Важные особенности

- **Приложение не знает о mTLS** - работает с обычным HTTP
- **Шифрование прозрачно** - обрабатывается Envoy автоматически
- **Автоматическое управление** - сертификаты выдаются и обновляются автоматически
- **Защита на уровне сети** - весь трафик между подами зашифрован

## Следующие шаги

В следующей секции курса:
- Заключение и итоги курса (Section 20)




